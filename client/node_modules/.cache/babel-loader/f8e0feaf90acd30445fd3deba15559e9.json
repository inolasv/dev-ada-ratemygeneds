{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.EstimatedDocumentCountOperation = void 0;\n\nconst utils_1 = require(\"../utils\");\n\nconst command_1 = require(\"./command\");\n\nconst operation_1 = require(\"./operation\");\n/** @internal */\n\n\nclass EstimatedDocumentCountOperation extends command_1.CommandOperation {\n  constructor(collection) {\n    let options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    super(collection, options);\n    this.options = options;\n    this.collectionName = collection.collectionName;\n  }\n\n  execute(server, session, callback) {\n    if ((0, utils_1.maxWireVersion)(server) < 12) {\n      return this.executeLegacy(server, session, callback);\n    }\n\n    const pipeline = [{\n      $collStats: {\n        count: {}\n      }\n    }, {\n      $group: {\n        _id: 1,\n        n: {\n          $sum: '$count'\n        }\n      }\n    }];\n    const cmd = {\n      aggregate: this.collectionName,\n      pipeline,\n      cursor: {}\n    };\n\n    if (typeof this.options.maxTimeMS === 'number') {\n      cmd.maxTimeMS = this.options.maxTimeMS;\n    }\n\n    super.executeCommand(server, session, cmd, (err, response) => {\n      var _a, _b;\n\n      if (err && err.code !== 26) {\n        callback(err);\n        return;\n      }\n\n      callback(undefined, ((_b = (_a = response === null || response === void 0 ? void 0 : response.cursor) === null || _a === void 0 ? void 0 : _a.firstBatch[0]) === null || _b === void 0 ? void 0 : _b.n) || 0);\n    });\n  }\n\n  executeLegacy(server, session, callback) {\n    const cmd = {\n      count: this.collectionName\n    };\n\n    if (typeof this.options.maxTimeMS === 'number') {\n      cmd.maxTimeMS = this.options.maxTimeMS;\n    }\n\n    super.executeCommand(server, session, cmd, (err, response) => {\n      if (err) {\n        callback(err);\n        return;\n      }\n\n      callback(undefined, response.n || 0);\n    });\n  }\n\n}\n\nexports.EstimatedDocumentCountOperation = EstimatedDocumentCountOperation;\n(0, operation_1.defineAspects)(EstimatedDocumentCountOperation, [operation_1.Aspect.READ_OPERATION, operation_1.Aspect.RETRYABLE, operation_1.Aspect.CURSOR_CREATING]);","map":null,"metadata":{},"sourceType":"script"}